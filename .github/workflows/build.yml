name: Build · nRF52840DK

on:
  push: { branches: [main, master] }
  pull_request:
  workflow_dispatch:

env:
  BOARD: nrf52840dk_nrf52840
  NCS_TAG: v3.0.2

jobs:
  build:
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/nrfconnect/sdk-nrf-toolchain:v3.0.2
      options: --user root

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ✅ west 전역 설치(없을 때만). Debian/Ubuntu, Alpine 모두 대비.
      - name: Install west (global)
        shell: bash
        run: |
          set -euxo pipefail
          if ! command -v python3 >/dev/null 2>&1; then
            echo "python3 not found"; exit 1
          fi
          if ! python3 -m pip -V >/dev/null 2>&1; then
            if command -v apt-get >/dev/null 2>&1; then
              apt-get update
              apt-get install -y python3-pip
            elif command -v apk >/dev/null 2>&1; then
              apk add --no-cache py3-pip
            fi
          fi
          python3 -m pip install --upgrade pip --break-system-packages || true
          python3 -m pip install --upgrade west --break-system-packages || python3 -m pip install --user --upgrade west
          echo "$HOME/.local/bin" >> "$GITHUB_PATH" || true
          hash -r || true
          which west || true
          west --version

      - name: Git safe.directory
        run: git config --global --add safe.directory '*'

      # 루트에 west.yml이 있다는 전제
      - name: west init (local)
        run: west init -l .

      - name: Cache NCS deps
        uses: actions/cache@v4
        with:
          path: |
            .west
            zephyr
            nrf
            modules
            nrfxlib
            bootloader
          key: ncs-${{ runner.os }}-${{ env.NCS_TAG }}
          restore-keys: |
            ncs-${{ runner.os }}-

      - name: west update & export
        run: |
          west update --narrow -o=--depth=1
          west zephyr-export

      - name: Build (${{ env.BOARD }})
        env: { BOARD: ${{ env.BOARD }} }
        run: |
          west build -p always -b "$BOARD" --sysbuild .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.BOARD }}-${{ env.NCS_TAG }}"
          path: |
            build/zephyr/*.hex
            build/zephyr/*.bin
            build/zephyr/*.elf
            build/mcuboot/zephyr/*.hex
          if-no-files-found: warn
