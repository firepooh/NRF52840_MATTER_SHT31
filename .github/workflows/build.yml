name: Nordic nRF Build

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/nrfconnect/sdk-nrf-toolchain:v3.0.2
      env:
        ACCEPT_JLINK_LICENSE: 1
      options: --privileged
    defaults:
      run:
        shell: bash
        
    steps:
    - name: Checkout
      uses: actions/checkout@v4
        
    - name: Setup workspace
      run: |
        # 현재 위치 확인
        pwd
        ls -la
        
        # Git 안전 디렉토리 설정
        git config --global --add safe.directory '*'
        
        # West 초기화
        west init -l .
        
        # West 업데이트 (명령 가져오기)
        west update
        
    - name: Build firmware
      run: |
        # 정리된 빌드 (경로 불일치 문제 방지)
        west build -b nrf52840dk/nrf52840 --pristine \
          -- -DCONFIG_CHIP_DEVICE_PRODUCT_ID=32768
        
    - name: Check build output
      run: |
        echo "Build completed successfully!"
        find build -name "*.hex" -o -name "*.elf" -o -name "*.bin" | head -10
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-nrf52840dk
        path: |
          build/zephyr/zephyr.hex
          build/zephyr/zephyr.elf
        retention-days: 7