name: Build Â· nRF52840DK (NCS Â· Container)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

env:
  BOARD: nrf52840dk_nrf52840
  NCS_VERSION: v3.0.2   # í•„ìš”ì‹œ ë³€ê²½
  APP_DIR: ${{ github.workspace }}

jobs:
  build:
    runs-on: ubuntu-latest

    # ğŸ§° Nordic ì»¨í…Œì´ë„ˆ: west/cmake/ninja í¬í•¨
    # ë¬¸ì œê°€ ìˆìœ¼ë©´ 'main' ìœ ì§€, íŠ¹ì • ë²„ì „ ê³ ì •í•˜ë ¤ë©´ :v3.0.2 ë“±ìœ¼ë¡œ êµì²´
    container:
      image: ghcr.io/nrfconnect/sdk-nrf:v3.0.2
      options: --user root

    steps:
      - name: Checkout app repository
        uses: actions/checkout@v4

      # ì¼ë¶€ íƒœê·¸ì—ì„œ pip/westê°€ ë¹ ì ¸ìˆëŠ” ê²½ìš° ëŒ€ë¹„ (ìˆìœ¼ë©´ ë²„ì „ë§Œ ì¶œë ¥)
      - name: Ensure pip & west
        shell: bash
        run: |
          set -euxo pipefail
          if ! python3 -c "import pip" >/dev/null 2>&1; then
            python3 -m ensurepip --upgrade || true
          fi
          if ! python3 -c "import pip" >/dev/null 2>&1; then
            if command -v apt-get >/dev/null 2>&1; then
              apt-get update
              apt-get install -y python3-pip
            elif command -v apk >/dev/null 2>&1; then
              apk add --no-cache py3-pip
            fi
          fi
          python3 -m pip install --upgrade pip
          if ! command -v west >/dev/null 2>&1; then
            python3 -m pip install --user --upgrade west
            echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          fi
          which west
          west --version
          cmake --version
          ninja --version || true

      # ì»¨í…Œì´ë„ˆì—ì„œ git ì•ˆì „ ë””ë ‰í† ë¦¬ ê²½ê³  ë°©ì§€
      - name: Git safe.directory
        run: git config --global --add safe.directory '*'

      - name: Prepare NCS workspace (west init)
        run: |
          mkdir -p /opt/ncs
          cd /opt/ncs
          west init -m https://github.com/nrfconnect/sdk-nrf --mr "${NCS_VERSION}" ncs

      # ğŸ‘‰ NCS ëª¨ë“ˆ ìºì‹œ (ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•)
      - name: Cache NCS dependencies
        uses: actions/cache@v4
        with:
          path: |
            /opt/ncs/ncs/.west
            /opt/ncs/ncs/zephyr
            /opt/ncs/ncs/nrf
            /opt/ncs/ncs/modules
            /opt/ncs/ncs/nrfxlib
            /opt/ncs/ncs/bootloader
          key: ncs-${{ env.NCS_VERSION }}-${{ runner.os }}-v1
          restore-keys: |
            ncs-${{ env.NCS_VERSION }}-

      - name: Update & export NCS
        working-directory: /opt/ncs/ncs
        run: |
          west update --narrow -o=--depth=1
          west zephyr-export

      # í•„ìš” ì‹œ EXTRA_CONF/OVERLAY ë“± ì¶”ê°€
      - name: Build (sysbuild Â· ${BOARD})
        working-directory: /opt/ncs/ncs
        env:
          BOARD: ${{ env.BOARD }}
          APP_DIR: ${{ env.APP_DIR }}
        run: |
          # ì˜ˆ) ì˜¤ë²„ë ˆì´ ì“°ë ¤ë©´: EXTRA="-DOVERLAY_CONFIG=prj_release.conf"
          EXTRA=""
          west build -p always -b "$BOARD" --sysbuild "$APP_DIR" -- $EXTRA

      # ì„ íƒ: ë¦¬í¬íŠ¸ íƒ€ê¹ƒ (ê°€ëŠ¥í•œ ë²„ì „ì—ì„œë§Œ ì‹¤í–‰, ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš° ê³„ì†)
      - name: Reports (partition/size)
        if: always()
        working-directory: /opt/ncs/ncs
        continue-on-error: true
        run: |
          west build -t partition_manager_report || true
          west build -t rom_report || true
          west build -t ram_report || true

      - name: List build outputs
        run: |
          echo "== Build tree =="
          find /opt/ncs/ncs/build -maxdepth 4 -type f | sort || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{
            env.BOARD
          }}-${{
            env.NCS_VERSION
          }}
          path: |
            /opt/ncs/ncs/build/zephyr/*.hex
            /opt/ncs/ncs/build/zephyr/*.bin
            /opt/ncs/ncs/build/zephyr/*.elf
            /opt/ncs/ncs/build/mcuboot/zephyr/*.hex
            /opt/ncs/ncs/build/zephyr/zephyr*.map
            /opt/ncs/ncs/build/zephyr/*.json
          if-no-files-found: warn
