name: Build (nRF52840DK · NCS)

on:
  push:
    branches: [ master, main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/nrfconnect/sdk-nrf-toolchain:latest
      options: --user root

    strategy:
      matrix:
        board:  [ nrf52840dk_nrf52840 ]
        ncs:    [ v3.0.2 ]
        config: [ debug ]

    steps:
      - name: Checkout app
        uses: actions/checkout@v4

      # ❗ west가 없으면 설치(+ PATH 등록). 있으면 버전만 출력
      - name: Ensure west available
        run: |
          if ! command -v west >/dev/null 2>&1; then
            python3 -m pip install --user --upgrade west
            echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          fi
          which west || true
          west --version

      # Git 안전 디렉토리 경고 방지 (Nordic 문서 권장)
      - name: Git safe.directory
        run: git config --global --add safe.directory '*'

      - name: Prepare west workspace (init)
        run: |
          mkdir -p /opt/ncs
          cd /opt/ncs
          west init -m https://github.com/nrfconnect/sdk-nrf --mr ${{ matrix.ncs }} ncs

      - name: Cache NCS deps
        uses: actions/cache@v4
        with:
          path: |
            /opt/ncs/ncs/.west
            /opt/ncs/ncs/zephyr
            /opt/ncs/ncs/nrf
            /opt/ncs/ncs/modules
            /opt/ncs/ncs/nrfxlib
            /opt/ncs/ncs/bootloader
          key: ncs-${{ matrix.ncs }}-${{ runner.os }}-v1

      - name: Update & export NCS
        working-directory: /opt/ncs/ncs
        run: |
          west update --narrow -o=--depth=1
          west zephyr-export

      - name: Build (${{ matrix.board }})
        working-directory: /opt/ncs/ncs
        env:
          BOARD: ${{ matrix.board }}
        run: |
          west build -p always -b "$BOARD" --sysbuild "$GITHUB_WORKSPACE"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.board }}-${{ matrix.config }}-${{ matrix.ncs }}
          path: |
            /opt/ncs/ncs/build/zephyr/*.hex
            /opt/ncs/ncs/build/zephyr/*.bin
            /opt/ncs/ncs/build/zephyr/*.elf
            /opt/ncs/ncs/build/mcuboot/zephyr/*.hex
