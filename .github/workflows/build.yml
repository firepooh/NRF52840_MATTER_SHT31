name: Nordic nRF Build

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container: 
      image: nordicplayground/nrfconnect-sdk:v3.0.2
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        path: template
        
    - name: Check repository structure
      run: |
        echo "Container working directory:"
        pwd
        ls -la
        echo ""
        echo "Template directory:"
        ls -la template/
        
    - name: Setup workspace in container
      run: |
        # 작업 디렉토리로 이동
        cd /workdir
        
        # west.yml이 있는 template 디렉토리에서 초기화
        cd template
        
        echo "Initializing west workspace..."
        west init -l .
        
        echo "Updating dependencies..."
        west update --narrow -o=--depth=1
        
    - name: Build firmware
      run: |
        cd /workdir/template
        
        echo "Attempting build..."
        west build -b nrf52840dk/nrf52840 -- -DCONFIG_CHIP_DEVICE_PRODUCT_ID=32768
        
    - name: Check build output
      run: |
        cd /workdir/template
        echo "Build directory contents:"
        ls -la build/ || echo "No build directory"
        echo ""
        if [ -d "build/zephyr" ]; then
          echo "Zephyr directory:"
          ls -la build/zephyr/
          echo ""
          echo "Generated files:"
          find build/zephyr -name "*.hex" -o -name "*.elf" -o -name "*.bin" | head -10
        fi
        
    - name: Copy artifacts from container
      run: |
        cd /workdir/template
        mkdir -p /tmp/artifacts
        if [ -f "build/zephyr/zephyr.hex" ]; then
          cp build/zephyr/zephyr.hex /tmp/artifacts/
        fi
        if [ -f "build/zephyr/zephyr.elf" ]; then
          cp build/zephyr/zephyr.elf /tmp/artifacts/
        fi
        ls -la /tmp/artifacts/
        
    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-files
        path: /tmp/artifacts/
        retention-days: 7